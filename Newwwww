import pandas as pd
from datetime import datetime
from tkinter import Tk, filedialog
import os
from openpyxl import load_workbook
from openpyxl.styles import PatternFill, Font, Border, Side, Alignment

# ---------- File Picker ----------
Tk().withdraw()
print("Select the single Excel file containing all domain sheets:")
file_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")])
if not file_path:
    raise SystemExit("❌ No file selected. Exiting.")

timestamp = datetime.now().strftime("%Y-%m-%d_%Hh%Mm")
output_file = f"Output_{timestamp}.xlsx"

# ---------- Cleaning & Computation Helpers ----------
def clean_col_c_drop_blanks(df):
    """Remove rows where column C is '(blank)', NaN, or empty."""
    c = df.columns[2]
    df[c] = df[c].astype(str).str.strip()
    df[c] = df[c].replace({
        "(blank)": None, "": None, " ": None,
        "nan": None, "NaN": None, "None": None, "NULL": None
    })
    before = len(df)
    df = df.dropna(subset=[c])
    dropped = before - len(df)
    return df, dropped

def coerce_weights_and_scores(df):
    """Ensure numeric, drop NaNs, and normalize percent scale."""
    w_col = df.columns[3]
    s_col = df.columns[5]

    for col in [w_col, s_col]:
        df[col] = df[col].astype(str).str.strip()
        df[col] = df[col].replace(
            {"": None, " ", "-", "_", "nan": None, "NaN": None,
             "None": None, "NULL": None}
        )

    df[w_col] = pd.to_numeric(df[w_col], errors="coerce")
    df[s_col] = pd.to_numeric(df[s_col], errors="coerce")

    before = len(df)
    df = df.dropna(subset=[w_col, s_col])
    dropped = before - len(df)

    if df[s_col].max() <= 1.5:
        df[s_col] = df[s_col] * 100.0

    return df, w_col, s_col, dropped

def weighted_average(df, w_col, s_col):
    """Compute weighted average (0–1 scale)."""
    w_sum = df[w_col].sum()
    if w_sum == 0 or pd.isna(w_sum):
        return float("nan")
    return (df[w_col] * (df[s_col] / 100.0)).sum() / w_sum

def process_domain(df):
    """Apply cleaning and compute weighted average for one domain sheet."""
    df, dropped_blankC = clean_col_c_drop_blanks(df)
    df, w_col, s_col, dropped_nan = coerce_weights_and_scores(df)

    wavg_raw = weighted_average(df, w_col, s_col)
    wavg_percent = wavg_raw * 100.0

    label_col = df.columns[-2] if len(df.columns) >= 2 else df.columns[-1]
    value_col = df.columns[-1]
    rows_to_add = [
        {**{col: None for col in df.columns},
         label_col: "Raw Weighted Average", value_col: f"{wavg_raw:.8f}"},
        {**{col: None for col in df.columns},
         label_col: "Weighted Average (%)", value_col: f"{wavg_percent:.8f}"}
    ]
    df_out = pd.concat([df, pd.DataFrame(rows_to_add)], ignore_index=True)
    return df_out, wavg_percent, wavg_raw, dropped_blankC, dropped_nan

# ---------- Main Processing ----------
summary_rows = []

with pd.ExcelWriter(output_file, engine="openpyxl") as writer:
    all_sheets = pd.read_excel(file_path, sheet_name=None)

    for sheet_name, df in all_sheets.items():
        name_lower = sheet_name.lower().strip()
        if name_lower.startswith("d"):
            domain = "D"
        elif name_lower.startswith("g"):
            domain = "G"
        elif name_lower.startswith("h"):
            domain = "H"
        else:
            print(f"Skipping sheet '{sheet_name}' (not D/G/H).")
            continue

        df_out, wavg_percent, wavg_raw, dropped_blankC, dropped_nan = process_domain(df)
        df_out.to_excel(writer, sheet_name=domain, index=False)
        summary_rows.append((domain, round(wavg_percent, 2)))
        print(f"{domain}: dropped {dropped_blankC} '(blank)' and {dropped_nan} NaN rows. Weighted Avg = {wavg_percent:.8f}")

    # Summary sheet
    summary_df = pd.DataFrame(summary_rows, columns=["Domain", "Weighted Avg (%)"])
    overall = round(summary_df["Weighted Avg (%)"].dropna().mean(), 2)
    summary_df.loc[len(summary_df)] = ["Total Average", overall]
    summary_df.to_excel(writer, sheet_name="Summary", index=False)

# ---------- Excel Formatting ----------
wb = load_workbook(output_file)

green_fill = PatternFill(start_color="C6EFCE", end_color="C6EFCE", fill_type="solid")
blue_fill = PatternFill(start_color="D9E1F2", end_color="D9E1F2", fill_type="solid")
border = Border(
    left=Side(style="thin"), right=Side(style="thin"),
    top=Side(style="thin"), bottom=Side(style="thin")
)

# Format domain sheets
for sheet in wb.sheetnames:
    if sheet == "Summary":
        continue
    ws = wb[sheet]
    for row in ws.iter_rows():
        for cell in row:
            if cell.value and isinstance(cell.value, str) and "Weighted Average" in cell.value:
                cell.fill = green_fill
                cell.font = Font(bold=True)
                value_cell = ws.cell(row=cell.row, column=ws.max_column)
                value_cell.fill = green_fill
                value_cell.font = Font(bold=True)

# Format summary sheet
ws = wb["Summary"]
for row in ws.iter_rows():
    for cell in row:
        cell.border = border
        cell.alignment = Alignment(horizontal="center", vertical="center")

for cell in ws[1]:
    cell.font = Font(bold=True)
    cell.fill = blue_fill

for cell in ws[ws.max_row]:
    cell.fill = green_fill
    cell.font = Font(bold=True)

ws.column_dimensions["A"].width = 15
ws.column_dimensions["B"].width = 20

for cell in ws["B"]:
    if cell.row != 1:
        cell.number_format = "0.00"

wb.save(output_file)
print(f"\n✅ Done! File saved and formatted as {output_file}")
